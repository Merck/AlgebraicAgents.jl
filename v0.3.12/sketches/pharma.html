<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>A Toy Pharma Model · AlgebraicAgents.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../index.html">AlgebraicAgents.jl</a></span></div><form class="docs-search" action="../search.html"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../index.html">API Documentation</a></li><li><a class="tocitem" href="../design.html">Framework design</a></li><li><span class="tocitem">Integrations</span><ul><li><a class="tocitem" href="../integrations/AgentsIntegration.html">Agents.jl Integration</a></li><li><a class="tocitem" href="../integrations/SciMLIntegration.html">SciML Integration</a></li><li><a class="tocitem" href="../integrations/AlgebraicDynamicsIntegration.html">AlgebraicDynamics.jl Integration</a></li></ul></li><li><span class="tocitem">Three Sketches</span><ul><li><a class="tocitem" href="agents.html">Agents.jl Integration</a></li><li class="is-active"><a class="tocitem" href="pharma.html">A Toy Pharma Model</a><ul class="internal"><li><a class="tocitem" href="#Integrating-a-Custom-Dynamical-System"><span>Integrating a Custom Dynamical System</span></a></li><li class="toplevel"><a class="tocitem" href="#Adding-SDE-Models"><span>Adding SDE Models</span></a></li><li class="toplevel"><a class="tocitem" href="#Defining-and-Entangling-the-Systems"><span>Defining &amp; Entangling the Systems</span></a></li><li><a class="tocitem" href="#Simulating-the-System"><span>Simulating the System</span></a></li><li><a class="tocitem" href="#Plotting"><span>Plotting</span></a></li></ul></li><li><a class="tocitem" href="sciml.html">SciML Integration</a></li><li><a class="tocitem" href="algebraicdynamics.html">Lotka-Voltera Two Ways</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Three Sketches</a></li><li class="is-active"><a href="pharma.html">A Toy Pharma Model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="pharma.html">A Toy Pharma Model</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/Merck/AlgebraicAgents.jl/blob/main/docs/src/sketches/pharma.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="A-Toy-Pharma-Model"><a class="docs-heading-anchor" href="#A-Toy-Pharma-Model">A Toy Pharma Model</a><a id="A-Toy-Pharma-Model-1"></a><a class="docs-heading-anchor-permalink" href="#A-Toy-Pharma-Model" title="Permalink"></a></h1><p>We implement a toy pharma model. To that end, we have the following type hierarchy:</p><ul><li>overarching <strong>pharma model</strong> (represented by a <code>FreeAgent</code> span type),</li><li><strong>therapeutic area</strong> (represented by a <code>FreeAgent</code>), </li><li><strong>molecules</strong> (small, large - to demonstrate dynamic dispatch; alternatively, marketed drugs; a drug may drop out from the system,</li><li><strong>discovery unit</strong> (per therapeutic area); these generate new molecules according to a Poisson counting process,</li><li><strong>market demand</strong>; this will be represented by a stochastic differential equation implemented in <a href="https://github.com/SciML/DifferentialEquations.jl">DifferentialEquations.jl</a>.</li></ul><p>The next step is to define the molecules and discovery units types. This is done in <a href="https://github.com/Merck/AlgebraicAgents.jl/tree/main/tutorials/molecules/types.jl">there</a>; here we sketch an implementation of <code>SmallMolecule &lt;: Molecule &lt;: AbstractAlgebraicAgent</code> type.</p><h2 id="Integrating-a-Custom-Dynamical-System"><a class="docs-heading-anchor" href="#Integrating-a-Custom-Dynamical-System">Integrating a Custom Dynamical System</a><a id="Integrating-a-Custom-Dynamical-System-1"></a><a class="docs-heading-anchor-permalink" href="#Integrating-a-Custom-Dynamical-System" title="Permalink"></a></h2><pre><code class="language-julia hljs"># drug entity, lives in a therapeutic area
@aagent FreeAgent Molecule struct SmallMolecule
    age::Float64
    birth_time::Float64
    kill_time::Float64

    mol::AbstractString
    profile::NTuple{N, Float64}

    sales::Float64
    df_sales::DataFrame
end</code></pre><p>Note the use of a conveniency macro <code>@aagent</code> which appends additional fields expected (not required, though) by default interface methods.</p><p>Next we provide an evolutionary law for <code>SmallMolecule</code> type. This is done by extending the interface function <a href="../index.html#AlgebraicAgents._step!-Tuple{AbstractAlgebraicAgent}"><code>AlgebraicAgents._step!</code></a>.</p><pre><code class="language-julia hljs"># implement evolution
function AlgebraicAgents._step!(mol::SmallMolecule)
    t = projected_to(mol) # get current time; this equals the time point up to which the mol agent has been projected (enforced via `AlgebraicAgents.step!`)
    # log sales volume at time t
    push!(mol.df_sales, (t, mol.sales))
    # increment mol&#39;s age - by default, mols will evolve by unit step
    mol.age += 1
    # apply sales decay in time
    mol.sales *= sales_decay_small

    # remove mol 1) once sales volume drops below a given level
    # 2) also account for some random effect - prob of removal increases in time
    if (mol.sales &lt;= 10) || (rand() &gt;= exp(-0.2*mol.age))
        mol.kill_time = t
        push!(getagent(mol, &quot;../dx&quot;).removed_mols, (mol.mol, t))
        # remove mol from the system
        disentangle!(mol)
    end
end</code></pre><p>We provide additional methods required by the common interface:</p><pre><code class="language-julia hljs"># to reinit the system&#39;s state - since we have cold starts here, let&#39;s simply remove the mol
AlgebraicAgents._reinit!(mol::Molecule) = disentangle!(mol)
# return time to which the system has been projected
AlgebraicAgents._projected_to(mol::Molecule) = mol.age + mol.birth_time</code></pre><h1 id="Adding-SDE-Models"><a class="docs-heading-anchor" href="#Adding-SDE-Models">Adding SDE Models</a><a id="Adding-SDE-Models-1"></a><a class="docs-heading-anchor-permalink" href="#Adding-SDE-Models" title="Permalink"></a></h1><p>Let&#39;s define toy market demand model and represent this as a stochastic differential equation defined in <code>DifferentialEquations.jl</code></p><pre><code class="language-julia hljs"># add SDE models for drug demand in respective areas
using DifferentialEquations

dt = 1//2^(4); tspan = (0.0,100.)
f(u,p,t) = p[1]*u; g(u,p,t) = p[2]*u

prob_1 = SDEProblem(f,g,.9,tspan,[.01, .01])
prob_2 = SDEProblem(f,g,1.2,tspan,[.01, .01])</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">SDEProblem with uType Float64 and tType Float64. In-place: false
timespan: (0.0, 100.0)
u0: 1.2</code></pre><p>Internally, a discovery unit will adjust its productivity according to the observed market demand:</p><pre><code class="language-julia hljs"># sync with market demand
dx.productivity, = @observables dx &quot;../demand&quot;:&quot;demand&quot;</code></pre><h1 id="Defining-and-Entangling-the-Systems"><a class="docs-heading-anchor" href="#Defining-and-Entangling-the-Systems">Defining &amp; Entangling the Systems</a><a id="Defining-and-Entangling-the-Systems-1"></a><a class="docs-heading-anchor-permalink" href="#Defining-and-Entangling-the-Systems" title="Permalink"></a></h1><p>Next step is to initiate the actual dynamical systems.</p><pre><code class="language-julia hljs"># define therapeutic areas
therapeutic_area1 = FreeAgent(&quot;therapeutic_area1&quot;)
therapeutic_area2 = FreeAgent(&quot;therapeutic_area2&quot;)

# join therapeutic models into a pharma model
pharma_model = ⊕(therapeutic_area1, therapeutic_area2; name=&quot;pharma_model&quot;)

# initialize and push discovery units to therapeutic areas
# discovery units evolve at different pace
entangle!(therapeutic_area1, Discovery(&quot;dx&quot;, 5.2, 10.; dt=3.))
entangle!(therapeutic_area2, Discovery(&quot;dx&quot;, 6., 8.; dt=5.))

# add SDE models for drug demand in respective areas
demand_model_1 = DiffEqAgent(&quot;demand&quot;, prob_1, EM(); exposed_ports=Dict(&quot;demand&quot; =&gt; 1), dt)
demand_model_2 = DiffEqAgent(&quot;demand&quot;, prob_2, EM(); exposed_ports=Dict(&quot;demand&quot; =&gt; 1), dt)

# push market demand units to therapeutic areas
entangle!(therapeutic_area1, demand_model_1)
entangle!(therapeutic_area2, demand_model_2)

# show the model
pharma_model</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">agent <span class="sgr32"><span class="sgr1">pharma_model </span></span>with uuid <span class="sgr32">9a59fe4e </span>of type <span class="sgr32">FreeAgent </span>
   <span class="sgr1">inner agents: </span>
    agent <span class="sgr32"><span class="sgr1">therapeutic_area1 </span></span>with uuid <span class="sgr32">ad600045 </span>of type <span class="sgr32">FreeAgent </span>
       <span class="sgr1">inner agents: </span>demand, dx
    agent <span class="sgr32"><span class="sgr1">therapeutic_area2 </span></span>with uuid <span class="sgr32">8028630c </span>of type <span class="sgr32">FreeAgent </span>
       <span class="sgr1">inner agents: </span>demand, dx</code></pre><pre><code class="language-julia hljs">getagent(pharma_model, glob&quot;therapeutic_area?/&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">2-element Vector{FreeAgent}:
 FreeAgent{name=therapeutic_area2, uuid=8028630c, parent=FreeAgent{name=pharma_model, uuid=9a59fe4e, parent=nothing}}
 FreeAgent{name=therapeutic_area1, uuid=ad600045, parent=FreeAgent{name=pharma_model, uuid=9a59fe4e, parent=nothing}}</code></pre><h2 id="Simulating-the-System"><a class="docs-heading-anchor" href="#Simulating-the-System">Simulating the System</a><a id="Simulating-the-System-1"></a><a class="docs-heading-anchor-permalink" href="#Simulating-the-System" title="Permalink"></a></h2><p>Let&#39;s next evolve the compound model over a hundred time units. The last argument is optional here; see <code>?simulate</code> for the details.</p><pre><code class="language-julia hljs"># let the problem evolve
simulate(pharma_model, 100)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">agent <span class="sgr32"><span class="sgr1">pharma_model </span></span>with uuid <span class="sgr32">9a59fe4e </span>of type <span class="sgr32">FreeAgent </span>
   <span class="sgr1">inner agents: </span>
    agent <span class="sgr32"><span class="sgr1">therapeutic_area1 </span></span>with uuid <span class="sgr32">ad600045 </span>of type <span class="sgr32">FreeAgent </span>
       <span class="sgr1">inner agents: </span>fQ9yL, KOILc, U7zOz, dx, b6aSI, yeWMf, 55XDe, l1SUW, hLCmY, 6L95s, 9e5J1, uGWum, Gb3mR, bmXdc, 4DFVZ, jFOLU, Dt7En, JzxeF, owKTT, hd7A3, cC4qP, EWMTz, byI0N, ki1Ri, fNZGl, Y9fjK, QWr9M, xgB5m, ermSr, jjbgu, wLlYl, 4e9jI, saSfC, 7Staf, wCZay, joPrQ, WzQVv, jGQf7, 1SlcV, iFDFJ, yeDeg, 5ddSV, bJ89X, wURl7, 6ciGR, 9yfrB, mBiuI, CZp7T, i3uR2, GZcuh, Uslf4, 67IDd, D2Mii, a5FRs, AM1Pf, QmOZI, MCCaM, Ycn9Z, YGLFL, vNJv6, bsld5, BjAde, JCQ44, Qp34w, demand, yLzBt, 3nCLk, pTpeW, tihZJ, 0E4HN, 8hL59, ZNXci, i9LBF, 3bsTc, wutrP, hgQmh, WdHn9, XO8H7, WU0xO, 0GbxG, XG5V1, FkigB, 0GVt3, ssynq, uDFHS, cyPCm, 0ExKv, MjUo5, POLBY, NdJgJ, Z8pBV, R9cKe, Rzkue
    agent <span class="sgr32"><span class="sgr1">therapeutic_area2 </span></span>with uuid <span class="sgr32">8028630c </span>of type <span class="sgr32">FreeAgent </span>
       <span class="sgr1">inner agents: </span>lfOmH, Oyjls, HJeGN, dx, XC8SP, eOE5b, 9D4pY, 1Rovy, demand, hHyBt, LujfK</code></pre><pre><code class="language-julia hljs">getagent(pharma_model, &quot;therapeutic_area1/dx&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">agent <span class="sgr32"><span class="sgr1">dx </span></span>with uuid <span class="sgr32">59021cb5 </span>of type <span class="sgr32">Main.Discovery </span>
   custom properties:
   <span class="sgr3">rate_small: </span>5.2
   <span class="sgr3">rate_large: </span>10.0
   <span class="sgr3">productivity: </span>2.532800543748696
   <span class="sgr3">t: </span>102.0
   <span class="sgr3">dt: </span>3.0
   <span class="sgr3">t0: </span>0.0
   <span class="sgr3">removed_mols: </span>[(&quot;FrdeM&quot;, 99.0), (&quot;1COe3&quot;, 99.0), (&quot;P3EPp&quot;, 99.0), (&quot;BtBk9&quot;, 99.0), (&quot;0SYuE&quot;, 99.0), (&quot;9DvyS&quot;, 99.0), (&quot;BzXFi&quot;, 99.0), (&quot;ANdRW&quot;, 99.0), (&quot;sgvFK&quot;, 99.0), (&quot;dI03n&quot;, 99.0)  …  (&quot;RpJrd&quot;, 99.0), (&quot;qJh8T&quot;, 99.0), (&quot;XrGkD&quot;, 99.0), (&quot;z7PgD&quot;, 99.0), (&quot;8aFoH&quot;, 99.0), (&quot;w42BP&quot;, 99.0), (&quot;2rYKB&quot;, 99.0), (&quot;HYfGM&quot;, 99.0), (&quot;wK6xA&quot;, 99.0), (&quot;BWr7v&quot;, 99.0)]
   <span class="sgr3">df_output: </span>34×4 DataFrame
 Row │ time     small  large  removed
     │ Float64  Int64  Int64  Int64
─────┼────────────────────────────────
   1 │     0.0     15     31        0
   2 │     3.0     19     32       38
   3 │     6.0     14     32       46
   4 │     9.0     14     38       46
   5 │    12.0     18     33       55
   6 │    15.0     16     29       53
   7 │    18.0     21     25       42
   8 │    21.0     20     43       41
  ⋮  │    ⋮       ⋮      ⋮       ⋮
  28 │    81.0     39     67       74
  29 │    84.0     38     61       98
  30 │    87.0     40     65      109
  31 │    90.0     41     49      106
  32 │    93.0     40     66       96
  33 │    96.0     33     76       99
  34 │    99.0     34     78      106
                       19 rows omitted
   <span class="sgr1">parent: </span><span class="sgr32">therapeutic_area1</span></code></pre><pre><code class="language-julia hljs">getagent(pharma_model, &quot;therapeutic_area1/demand&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">agent <span class="sgr32"><span class="sgr1">demand </span></span>with uuid <span class="sgr32">a91e5689 </span>of type <span class="sgr32">DiffEqAgent </span>
   custom properties:
   <span class="sgr3">integrator: </span>
t: 100.0
u: 2.5764487191894188
   <span class="sgr3">ports out: </span>demand
   <span class="sgr1">parent: </span><span class="sgr32">therapeutic_area1</span></code></pre><h2 id="Plotting"><a class="docs-heading-anchor" href="#Plotting">Plotting</a><a id="Plotting-1"></a><a class="docs-heading-anchor-permalink" href="#Plotting" title="Permalink"></a></h2><p>It&#39;s possible to provide custom plotting recipes by specializing the interface method <code>AlgebraicAgents._draw(agent)</code>. Whenever a dynamical system&#39;s state is logged into a single DataFrame - as is the case with <code>Discovery</code> type - you may utilize a convenience macro <code>@draw_df</code>. To that end, we need to load <code>DataFrames</code> and <code>Plots</code>.</p><pre><code class="language-julia hljs"># implement plots
using DataFrames, Plots
AlgebraicAgents.@draw_df Discovery df_output</code></pre><p>To see this in action, call</p><pre><code class="language-julia hljs">draw(getagent(pharma_model, &quot;therapeutic_area1/dx&quot;))</code></pre><p><img src="../assets/plot.png" alt="plot"/></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="agents.html">« Agents.jl Integration</a><a class="docs-footer-nextpage" href="sciml.html">SciML Integration »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Wednesday 1 March 2023 01:49">Wednesday 1 March 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
